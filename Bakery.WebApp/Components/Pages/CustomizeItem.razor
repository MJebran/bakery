@page "/customizeItem/{baseItemId}"
@using Bakery.ClassLibrary.Services
@using Bakery.WebApp.Data
@using Bakery.WebApp.Services
@using Bakery.WebApp.Authentication
@inject IItemTypeService _itemservice
@inject IToppingService _toppingservice
@inject ICustomItemService _customItemService
@inject IPurchaseService _purchaseservice
@inject IItemPurchaseService _itemPurchaseService
@inject IBakeryAutheticationService _authenticationService
@inject ICustomeItemToppingService _customItemToppingService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer
<div class="background-page">
<div class="bottom-back">
<a href="/menuContents">
<div class="back">
                Back
</div>
</a>
</div>
<div class="ImagineCustomer">image</div>
<div class="size">size</div>
<div class="description">description</div>
</div>
 
<style>
    .background-page {
        background-image: linear-gradient(0deg, rgba(254.00000005960464, 206.0000029206276, 201.00000321865082, 1) 0%,rgba(255, 255, 255, 0) 100%);
        width: 100%;
        height: 1031px;im do
        position: absolute;
        left: 0px;
        top: 0px;
    }
 
    .bottom-back {
        grid-column: 1 / span 2;
        grid-row: 1;
        background-color: aqua;
        position: relative;
         }
 
    .ImagineCustomer {
        grid-column: 1 / span 2;
        grid-row: 2;
        background-color: red;
    }
 
    .size {
        grid-column: 1 / span 2;
        grid-row: 3;
        background-color: green;
    }
 
    .description {
        grid-column: 1 / span 2;
        grid-row: 4;
        background-color: yellow;
    }
 
    .back {
        background-color: rgba(236, 158, 73, 1);
        width: 50px;
        height: 50px;
        positi35px;
        top: -10px;
        }
</style>
tiene men√∫ contextual
@if (baseItem is not null)
{
    <div>
    <diV>
        <img
            src="@($"https://kakeybakerystorage.blob.core.windows.net/itemcontainer/{baseItem.ItemName?.Replace(" ", "")}")" />
    </diV>
    <div>
        @if (toppingToQuantity is not null)
            {
                @foreach (var toppingAndQuantity in toppingToQuantity)
                {
                    <div>
                        <button @onclick="() => DecreaseToppingAmount(toppingAndQuantity.Key)">-</button>
                        <div>
                            <img style="height:40px"
                                src="@($"https://kakeybakerystorage.blob.core.windows.net/itemcontainer/{toppingAndQuantity.Key.ToppingName?.Replace(" ", "")}")" />
                        </div>
                        <div>@toppingAndQuantity.Key.ToppingName</div>
                        <div>@toppingAndQuantity.Value</div>
                        <button @onclick="() => IncreaseToppingAmount(toppingAndQuantity.Key)">+</button>
                    </div>
                    <button @onclick="async () => await AddToCart()"> Order Now </button>
                    <div>Total: @ComputeTotalPrice()</div>
                }
            }
        </div>

        @if(ErrorMesage is not null)
        {
            <div class="alert alert-danger">
                @ErrorMesage
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public string? baseItemId { get; set; }
    public User? user { get; set; }
    public Customitem userCustomItem { get; set; } = new();
    public Itemtype? baseItem { get; set; }
    public Purchase? userCart { get; set; }
    public string? ErrorMesage {get; set;} = null;
    Dictionary<Topping, int>? toppingToQuantity { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var items = (await _itemservice.GetAllItemtypes()).ToList<Itemtype>();

        var toppings = (await _toppingservice.GetAllToppings()).ToList<Topping>();

        user = _authenticationService.GetAuthenticatedUser();

        baseItem = items
        .Where(i => i.ItemTypeId == Int32.Parse(baseItemId ?? ""))
        .First<Itemtype>();

        userCustomItem = new Customitem()
            {
                ItemId = baseItem?.ItemTypeId ?? 0
            };

        toppingToQuantity = new();

        foreach (var topping in toppings)
        {
            toppingToQuantity?.Add(topping, 0);
        }
    }

    public void IncreaseToppingAmount(Topping topping)
    {
        if (toppingToQuantity is not null)
            toppingToQuantity[topping] += 1;
    }

    public void DecreaseToppingAmount(Topping topping)
    {
        if (toppingToQuantity?[topping] > 0)
        {
            toppingToQuantity[topping] -= 1;
        }
    }

    public decimal ComputeTotalPrice()
    {
        decimal total = 0;

        if (toppingToQuantity is not null)
        {
            foreach (var toppingAndQuantity in toppingToQuantity)
            {
                total += toppingAndQuantity.Key.ToppingPrice * toppingAndQuantity.Value ?? 0.0m;
            }
        }

        total += baseItem?.ItemPrice ?? 0.0m;

        return total;
    }

    public async Task AddToCart()
    {
        if (!_authenticationService.UserExists())
        {
            ReturnErrorMessage();
            return;      
        }
        var purchases = (await _purchaseservice.GetAllPurchase()).ToList<Purchase>();

        if (purchases.Count() > 0)
        {
            userCart = purchases
            .Where(p => p.PurchaseUserId == user?.UserId && p.Ispayed == false)
            .FirstOrDefault<Purchase>();
        }

        if (userCart is null)
        {
            await CreateCartForUser();
            await AddToCart();
            return;
        }

        await _customItemService.AddCustomitem(userCustomItem);

        await AddCustomItemToppings(userCustomItem);

        await _itemPurchaseService.AddItempurchase(new Itempurchase()
            {
                ItempurchaseQuantity = 1,
                PurchaseId = userCart?.PurchaseId ?? 0,
                ItempurchaseItemId = userCustomItem.CustomItemId
            });

        NavigationManager.NavigateTo($"/cart/{userCart.PurchaseId}");
    }

    public async Task CreateCartForUser()
    {
        await _purchaseservice.AddPurchase(new Purchase()
            {
                PurchaseUserId = user?.UserId ?? 0,
                Ispayed = false
            });
    }

    public async Task AddCustomItemToppings(Customitem baseCustomItem)
    {
        if (toppingToQuantity is not null)
        {
            foreach (var toppingAndQuantity in toppingToQuantity)
            {
                if (toppingAndQuantity.Value > 0)
                {
                    await _customItemToppingService.AddCustomeItemTopping(new Customitemtopping()
                        {
                            CustomItemId = baseCustomItem.CustomItemId,
                            ToppingId = toppingAndQuantity.Key.ToppingId,
                            CustomItemToppingQuantity = toppingAndQuantity.Value
                        });
                }
            }
        }
    }

    public void ReturnErrorMessage()
    {
        ErrorMesage = "You're not logged in!";
    }
}
